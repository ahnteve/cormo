<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>CORMO - adapters/redis.ts</title><script>if (location.protocol.match(/^http/) && location.pathname.match('\.html') === null && location.pathname.slice(-1) !== '/') {
  location.href = location.href + '/';
}</script><link href="../bootstrap-3.2.0-dist/css/bootstrap.min.css" rel="stylesheet" type="text/css"><!--[if lt IE 9]><script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script><script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script><![endif]--><link href="../google-code-prettify/prettify.css" rel="stylesheet" type="text/css"><link href="../style.css" rel="stylesheet" type="text/css"></head><body data-spy="scroll" data-target=".sidebar"><nav class="navbar navbar-default navbar-fixed-top" role="navigation"><div class="navbar-header"><button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#top-navigation-collapse"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><div class="collapse navbar-collapse" id="top-navigation-collapse"><ul class="nav navbar-nav"><li><a href="../index.html">Home</a></li><li class="dropdown"><a class="dropdown-toggle" data-toggle="dropdown" href="#">Guides <span class="caret"></span></a><ul class="dropdown-menu"><li><a href="../guides/Aggregation.html">Aggregation</a></li><li><a href="../guides/Association.html">Association</a></li><li><a href="../guides/Callback.html">Callback</a></li><li><a href="../guides/Constraint.html">Constraint</a></li><li><a href="../guides/CreateRecords.html">Create records</a></li><li><a href="../guides/DefineModels.html">Define models</a></li><li><a href="../guides/Geospatial.html">Geospatial</a></li><li><a href="../guides/Miscellaneous.html">Miscellaneous</a></li><li><a href="../guides/Query.html">Query</a></li><li><a href="../guides/Validation.html">Validation</a></li></ul></li><li><a href="../modules/index.html">Modules</a></li><li><a href="../classes/index.html">Classes</a></li><li class="dropdown active"><a class="dropdown-toggle" data-toggle="dropdown" href="#">Files - adapters/redis.ts <span class="caret"></span></a><ul class="dropdown-menu"><li><a href="../files/decorators.ts.html">decorators.ts</a></li><li><a href="../files/index.ts.html">index.ts</a></li><li><a href="../files/query.ts.html">query.ts</a></li><li><a href="../files/transaction.ts.html">transaction.ts</a></li><li><a href="../files/types.ts.html">types.ts</a></li><li><a href="../files/adapters.base.ts.html">adapters/base.ts</a></li><li><a href="../files/adapters.mongodb.ts.html">adapters/mongodb.ts</a></li><li><a href="../files/adapters.mysql.ts.html">adapters/mysql.ts</a></li><li><a href="../files/adapters.postgresql.ts.html">adapters/postgresql.ts</a></li><li><a href="../files/adapters.redis.ts.html">adapters/redis.ts</a></li><li><a href="../files/adapters.sql_base.ts.html">adapters/sql_base.ts</a></li><li><a href="../files/adapters.sqlite3.ts.html">adapters/sqlite3.ts</a></li><li><a href="../files/adapters.sqlite3_memory.ts.html">adapters/sqlite3_memory.ts</a></li><li><a href="../files/command.index.ts.html">command/index.ts</a></li><li><a href="../files/connection.index.ts.html">connection/index.ts</a></li><li><a href="../files/logger.ColorConsoleLogger.ts.html">logger/ColorConsoleLogger.ts</a></li><li><a href="../files/logger.ConsoleLogger.ts.html">logger/ConsoleLogger.ts</a></li><li><a href="../files/logger.EmptyLogger.ts.html">logger/EmptyLogger.ts</a></li><li><a href="../files/logger.ILogger.ts.html">logger/ILogger.ts</a></li><li><a href="../files/logger.index.ts.html">logger/index.ts</a></li><li><a href="../files/model.index.ts.html">model/index.ts</a></li><li><a href="../files/util.index.ts.html">util/index.ts</a></li><li><a href="../files/util.inflector.ts.html">util/inflector.ts</a></li></ul></li></ul><div class="options"><label class="checkbox"><input id="options-private" type="checkbox"> Private </label></div></div></div></nav><div class="container-fluid content"><div class="row"><div class="hidden-xs sidebar col-sm-3" data-spy="affix"><div class="cormo-sidenav"><div class="panel panel-default"><div class="panel-collapse collapse in" id="undefined_body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/decorators.ts.html">decorators.ts</a></li><li><a href="../files/index.ts.html">index.ts</a></li><li><a href="../files/query.ts.html">query.ts</a></li><li><a href="../files/transaction.ts.html">transaction.ts</a></li><li><a href="../files/types.ts.html">types.ts</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#adapters__body">adapters/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="adapters__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/adapters.base.ts.html">base.ts</a></li><li><a href="../files/adapters.mongodb.ts.html">mongodb.ts</a></li><li><a href="../files/adapters.mysql.ts.html">mysql.ts</a></li><li><a href="../files/adapters.postgresql.ts.html">postgresql.ts</a></li><li class="active"><a href="../files/adapters.redis.ts.html">redis.ts</a></li><li><a href="../files/adapters.sql_base.ts.html">sql_base.ts</a></li><li><a href="../files/adapters.sqlite3.ts.html">sqlite3.ts</a></li><li><a href="../files/adapters.sqlite3_memory.ts.html">sqlite3_memory.ts</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#command__body">command/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="command__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/command.index.ts.html">index.ts</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#connection__body">connection/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="connection__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/connection.index.ts.html">index.ts</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#logger__body">logger/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="logger__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/logger.ColorConsoleLogger.ts.html">ColorConsoleLogger.ts</a></li><li><a href="../files/logger.ConsoleLogger.ts.html">ConsoleLogger.ts</a></li><li><a href="../files/logger.EmptyLogger.ts.html">EmptyLogger.ts</a></li><li><a href="../files/logger.ILogger.ts.html">ILogger.ts</a></li><li><a href="../files/logger.index.ts.html">index.ts</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#model__body">model/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="model__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/model.index.ts.html">index.ts</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#util__body">util/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="util__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/util.index.ts.html">index.ts</a></li><li><a href="../files/util.inflector.ts.html">inflector.ts</a></li></ul></div></div></div></div><div class="col-sm-9 col-sm-offset-3"><section><h1>adapters/redis.ts</h1></section><pre class="prettyprint">let redis: any;

try {
  // tslint:disable-next-line:no-var-requires
  redis = require('redis');
} catch (error) {
  console.log('Install redis module to use this adapter');
  process.exit(1);
}

export interface IAdapterSettingsRedis {
  host?: string;
  port?: number;
  database: string;
}

import * as _ from 'lodash';
import * as stream from 'stream';
import * as util from 'util';
import { Transaction } from '../transaction';
import * as types from '../types';
import { tableize } from '../util/inflector';
import { AdapterBase, IAdapterCountOptions, IAdapterFindOptions } from './base';

// Adapter for Redis
// @namespace adapter
class RedisAdapter extends AdapterBase {
  public support_upsert = false;

  public key_type: any = types.Integer;

  private _client: any;

  // Creates a Redis adapter
  constructor(connection: any) {
    super();
    this._connection = connection;
  }

  public async drop(model: string) {
    await this.delete(model, [], {});
  }

  public valueToDB(value: any, column: any, property: any) {
    if (value == null) {
      return;
    }
    switch (property.type_class) {
      case types.Number:
      case types.Integer:
        return value.toString();
      case types.Date:
        return new Date(value).getTime().toString();
      case types.Boolean:
        if (value) {
          return '1';
        } else {
          return '0';
        }
        break;
      case types.Object:
        return JSON.stringify(value);
      default:
        return value;
    }
  }

  public async create(model: string, data: any, options: { transaction?: Transaction }): Promise&lt;any&gt; {
    data.$_$ = ''; // ensure that there is one argument(one field) at least
    let id;
    try {
      id = await this._client.incrAsync(`${tableize(model)}:_lastid`);
    } catch (error) {
      throw RedisAdapter.wrapError('unknown error', error);
    }
    try {
      await this._client.hmsetAsync(`${tableize(model)}:${id}`, data);
    } catch (error) {
      throw RedisAdapter.wrapError('unknown error', error);
    }
    return id;
  }

  public async createBulk(model: string, data: any[], options: { transaction?: Transaction }): Promise&lt;any[]&gt; {
    return await this._createBulkDefault(model, data, options);
  }

  public async update(model: string, data: any, options: { transaction?: Transaction }) {
    const key = `${tableize(model)}:${data.id}`;
    delete data.id;
    data.$_$ = ''; // ensure that there is one argument(one field) at least
    let exists;
    try {
      exists = (await this._client.existsAsync(key));
    } catch (error) {
      throw RedisAdapter.wrapError('unknown error', error);
    }
    if (!exists) {
      return;
    }
    try {
      await this._client.delAsync(key);
    } catch (error) {
      throw RedisAdapter.wrapError('unknown error', error);
    }
    try {
      await this._client.hmsetAsync(key, data);
    } catch (error) {
      throw RedisAdapter.wrapError('unknown error', error);
    }
  }

  public async updatePartial(
    model: string, data: any, conditions: any,
    options: { transaction?: Transaction },
  ): Promise&lt;number&gt; {
    const fields_to_del = Object.keys(data).filter((key) =&gt; data[key] == null);
    fields_to_del.forEach((key) =&gt; {
      return delete data[key];
    });
    fields_to_del.push('$_$'); // ensure that there is one argument at least
    const table = tableize(model);
    data.$_$ = ''; // ensure that there is one argument(one field) at least
    const keys = await this._getKeys(table, conditions);
    for (const key of keys) {
      const args = _.clone(fields_to_del);
      args.unshift(key);
      try {
        await this._client.hdelAsync(args);
      } catch (error) {
        throw RedisAdapter.wrapError('unknown error', error);
      }
      try {
        await this._client.hmsetAsync(key, data);
      } catch (error) {
        throw RedisAdapter.wrapError('unknown error', error);
      }
    }
    return keys.length;
  }

  public async upsert(model: string, data: any, conditions: any, options: any): Promise&lt;void&gt; {
    throw new Error('not implemented');
  }

  public async findById(
    model: string, id: any,
    options: { select?: string[], explain?: boolean, transaction?: Transaction },
  ): Promise&lt;any&gt; {
    let result;
    try {
      result = (await this._client.hgetallAsync(`${tableize(model)}:${id}`));
    } catch (error) {
      throw RedisAdapter.wrapError('unknown error', error);
    }
    if (result) {
      result.id = id;
      return this._convertToModelInstance(model, result, options);
    } else {
      throw new Error('not found');
    }
  }

  public async find(model: string, conditions: any, options: IAdapterFindOptions): Promise&lt;any&gt; {
    const table = tableize(model);
    const keys = await this._getKeys(table, conditions);
    let records: any[] = await Promise.all(keys.map(async (key: any) =&gt; {
      const result = await this._client.hgetallAsync(key);
      if (result) {
        result.id = Number(key.substr(table.length + 1));
      }
      return result;
    }));
    records = records.filter((record) =&gt; record != null);
    return records.map((record) =&gt; {
      return this._convertToModelInstance(model, record, options);
    });
  }

  public stream(model: any, conditions: any, options: any): stream.Readable {
    throw new Error('not implemented');
  }

  public async count(model: string, conditions: any, options: IAdapterCountOptions): Promise&lt;number&gt; {
    throw new Error('not implemented');
  }

  public async delete(model: string, conditions: any, options: { transaction?: Transaction }): Promise&lt;number&gt; {
    const keys = await this._getKeys(tableize(model), conditions);
    if (keys.length === 0) {
      return 0;
    }
    let count;
    try {
      count = (await this._client.delAsync(keys));
    } catch (error) {
      throw RedisAdapter.wrapError('unknown error', error);
    }
    return count;
  }

  public close(): void {
    //
  }

  /**
   * Connects to the database
   */
  public async connect(settings: IAdapterSettingsRedis) {
    const methods = ['del', 'exists', 'hdel', 'hgetall', 'hmset', 'incr', 'keys', 'select'];
    this._client = redis.createClient(settings.port || 6379, settings.host || '127.0.0.1');
    for (const method of methods) {
      this._client[method + 'Async'] = util.promisify(this._client[method]);
    }
    return (await this._client.selectAsync(settings.database || 0));
  }

  protected valueToModel(value: any, property: any) {
    switch (property.type_class) {
      case types.Number:
      case types.Integer:
        return Number(value);
      case types.Date:
        return new Date(Number(value));
      case types.Boolean:
        return value !== '0';
      case types.Object:
        return JSON.parse(value);
      default:
        return value;
    }
  }

  private async _getKeys(table: any, conditions: any) {
    if (Array.isArray(conditions)) {
      if (conditions.length === 0) {
        return (await this._client.keysAsync(`${table}:*`));
      }
      const all_keys: any[] = [];
      await Promise.all(conditions.map(async (condition) =&gt; {
        const keys = await this._getKeys(table, condition);
        [].push.apply(all_keys, keys);
      }));
      return all_keys;
    } else if (typeof conditions === 'object' &amp;&amp; conditions.id) {
      if (conditions.id.$in) {
        return conditions.id.$in.map((id: any) =&gt; `${table}:${id}`);
      } else {
        return [`${table}:${conditions.id}`];
      }
    }
    return [];
  }

}

export default (connection: any) =&gt; {
  return new RedisAdapter(connection);
};</pre></div></div></div><script src="http://code.jquery.com/jquery-1.11.0.min.js"></script><script src="../bootstrap-3.2.0-dist/js/bootstrap.min.js"></script><script src="../google-code-prettify/prettify.js"></script><script src="../script.js"></script><script src="../group-examples.js"></script><a href="https://github.com/croquiscom/cormo"><img class="github-ribbon" src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png" alt="Fork me on GitHub"></a></body></html>